from fastapi import FastAPI, Request
from fastapi.responses import JSONResponse
from datetime import datetime
import re

app = FastAPI()

# ì§ì ‘ ë„£ì€ ì˜ì–‘ì†Œ ë°ì´í„°
nutrition_data = {
  "6/17": {
    "íƒ„ìˆ˜í™”ë¬¼": "59%", "íƒ„ìˆ˜í™”ë¬¼ ìƒíƒœ": "ì ì •",
    "ë‹¨ë°±ì§ˆ": "22.4%", "ë‹¨ë°±ì§ˆ ìƒíƒœ": "ì•½ê°„ ë†’ìŒ",
    "ì§€ë°©": "16.0%", "ì§€ë°© ìƒíƒœ": "ì ì •",
    "ë¹„íƒ€ë¯¼A": "ì•½ê°„ ë¶€ì¡±",
    "ë¹„íƒ€ë¯¼C": "ì¶©ë¶„",
    "ì¹¼ìŠ˜": "ì¶©ë¶„",
    "ì² ë¶„": "ì•½ê°„ ë¶€ì¡±"
  },
  "6/18": {
    "íƒ„ìˆ˜í™”ë¬¼": "53.8%", "íƒ„ìˆ˜í™”ë¬¼ ìƒíƒœ": "ì•½ê°„ ë‚®ìŒ",
    "ë‹¨ë°±ì§ˆ": "17.9%", "ë‹¨ë°±ì§ˆ ìƒíƒœ": "ì ì •",
    "ì§€ë°©": "27.9%", "ì§€ë°© ìƒíƒœ": "ì ì •",
    "ë¹„íƒ€ë¯¼A": "ì•½ê°„ ë¶€ì¡±",
    "ë¹„íƒ€ë¯¼C": "ì¶©ë¶„",
    "ì¹¼ìŠ˜": "ì•½ê°„ ë¶€ì¡±",
    "ì² ë¶„": "ì•½ê°„ ë¶€ì¡±"
  },
  "6/19": {
    "íƒ„ìˆ˜í™”ë¬¼": "58.9%", "íƒ„ìˆ˜í™”ë¬¼ ìƒíƒœ": "ì ì •",
    "ë‹¨ë°±ì§ˆ": "16.6%", "ë‹¨ë°±ì§ˆ ìƒíƒœ": "ì ì •",
    "ì§€ë°©": "23.8%", "ì§€ë°© ìƒíƒœ": "ì ì •",
    "ë¹„íƒ€ë¯¼A": "ë¶€ì¡±",
    "ë¹„íƒ€ë¯¼C": "ì•½ê°„ ë¶€ì¡±",
    "ì¹¼ìŠ˜": "ì•½ê°„ ë¶€ì¡±",
    "ì² ë¶„": "ì¶©ë¶„"
  },
  "6/20": {
    "íƒ„ìˆ˜í™”ë¬¼": "62.5%", "íƒ„ìˆ˜í™”ë¬¼ ìƒíƒœ": "ì ì •",
    "ë‹¨ë°±ì§ˆ": "11.8%", "ë‹¨ë°±ì§ˆ ìƒíƒœ": "ì ì •",
    "ì§€ë°©": "22.3%", "ì§€ë°© ìƒíƒœ": "ì ì •",
    "ë¹„íƒ€ë¯¼A": "ë¶€ì¡±",
    "ë¹„íƒ€ë¯¼C": "ì•½ê°„ ë¶€ì¡±",
    "ì¹¼ìŠ˜": "ì¶©ë¶„",
    "ì² ë¶„": "ì•½ê°„ ë¶€ì¡±"
  },
  "6/23": {
    "íƒ„ìˆ˜í™”ë¬¼": "54.7%", "íƒ„ìˆ˜í™”ë¬¼ ìƒíƒœ": "ì ì •",
    "ë‹¨ë°±ì§ˆ": "19.1%", "ë‹¨ë°±ì§ˆ ìƒíƒœ": "ì ì •",
    "ì§€ë°©": "25.1%", "ì§€ë°© ìƒíƒœ": "ì ì •",
    "ë¹„íƒ€ë¯¼A": "ë¶€ì¡±",
    "ë¹„íƒ€ë¯¼C": "ì¶©ë¶„",
    "ì¹¼ìŠ˜": "ì•½ê°„ ë¶€ì¡±",
    "ì² ë¶„": "ì¶©ë¶„"
  }
}

def parse_date_from_text(text: str) -> str:
    text = text.strip()
    if "ì˜¤ëŠ˜" in text:
        today = datetime.now()
        return f"{today.month}/{str(today.day).zfill(2)}"
    match = re.search(r"6[./ì›”\s]?\s?([0-9]{1,2})[ì¼]?", text)
    if match:
        day = match.group(1).zfill(2)
        return f"6/{day}"
    return None

def get_nutrition_reply(date_key: str) -> str:
    data = nutrition_data.get(date_key)
    if not data:
        return "â— í•´ë‹¹ ë‚ ì§œì˜ ì˜ì–‘ì†Œ ë¶„ì„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."
    return (
        f"ğŸ“… 6ì›” {date_key[-2:]}ì¼ ì˜ì–‘ì†Œ ë¶„ì„:\n\n"
        f"ğŸ”¹ íƒ„ìˆ˜í™”ë¬¼: {data['íƒ„ìˆ˜í™”ë¬¼']} ({data['íƒ„ìˆ˜í™”ë¬¼ ìƒíƒœ']})\n"
        f"ğŸ”¹ ë‹¨ë°±ì§ˆ: {data['ë‹¨ë°±ì§ˆ']} ({data['ë‹¨ë°±ì§ˆ ìƒíƒœ']})\n"
        f"ğŸ”¹ ì§€ë°©: {data['ì§€ë°©']} ({data['ì§€ë°© ìƒíƒœ']})\n\n"
        f"ğŸ”¸ ë¹„íƒ€ë¯¼ A: {data['ë¹„íƒ€ë¯¼A']}\n"
        f"ğŸ”¸ ë¹„íƒ€ë¯¼ C: {data['ë¹„íƒ€ë¯¼C']}\n"
        f"ğŸ”¸ ì¹¼ìŠ˜: {data['ì¹¼ìŠ˜']}\n"
        f"ğŸ”¸ ì² ë¶„: {data['ì² ë¶„']}"
    )

@app.post("/nutrition")
async def nutrition_info(request: Request):
    try:
        body = await request.json()
        user_msg = body['userRequest']['utterance'].strip()
        date_key = parse_date_from_text(user_msg)

        if date_key:
            reply = get_nutrition_reply(date_key)
        else:
            reply = "ë¶„ì„ì„ ì›í•˜ëŠ” ë‚ ì§œë¥¼ '6ì›” 18ì¼' ë˜ëŠ” 'ì˜¤ëŠ˜'ì²˜ëŸ¼ ì…ë ¥í•´ì£¼ì„¸ìš”."

        return JSONResponse({
            "version": "2.0",
            "template": {
                "outputs": [{
                    "simpleText": {"text": reply}
                }]
            }
        })

    except Exception as e:
        print("Error:", e)
        return JSONResponse({
            "version": "2.0",
            "template": {
                "outputs": [{
                    "simpleText": {"text": "âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}
                }]
            }
        })
